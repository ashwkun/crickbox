# Wallstream & Wisden API Documentation



## 1. Overview
This application powers its live cricket data using a combination of **Wisden APIs** (for matches, scorecards, and historical data) and **Wallstream** (for real-time ball-by-ball commentary).

All requests are routed through a custom **CORS Proxy** to bypass browser restrictions and manage caching.

---

## 2. CORS Proxy Architecture

Direct calls to Wisden APIs from a browser will fail due to CORS. We use a Cloudflare Worker as a proxy.

- **Proxy URL**: `https://cricket-proxy.boxboxcric.workers.dev/?url=`
- **Logic**: Appends the target encoded URL as a query parameter.
- **Source Code**: `src/utils/api.ts`

**Example:**
```typescript
const target = "https://www.wisden.com/default.aspx?...";
const finalUrl = `${CORS_PROXY}${encodeURIComponent(target)}`;
```

---

## 3. API Endpoints

### A. Matches List (Live & Upcoming)
Fetches the main list of matches. Used for the Home Screen and finding valid `game_id`s.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/utils/useCricketData.ts` (Lines 67, 85) |
| **Poll Interval** | 15s (Live), 5m (Schedule) |
| **Sample Data** | [live_matches.json](api_samples/core/live_matches.json) |

**URL Structure:**
```text
https://www.wisden.com/default.aspx?methodtype=3&client={CLIENT_MATCHES}&sport=1&league=0&timezone=0530&language=en&gamestate={STATE}
```
- `gamestate=1`: Live Matches
- `gamestate=2`: Upcoming Matches
- `gamestate=4`: Recent Completed Matches (Last 2 days)
- `gamestate=3`: Archived Matches (Older, e.g., 2023 - *Avoid*)

---

### B. Results (Prefer for results)
Fetches past match results using a date range filter.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/utils/useCricketData.ts` (Lines 86, 184) |
| **Updates** | On Load / 5 minutes |
| **Sample Data** | [results_dec_2025.json](api_samples/core/results_dec_2025.json) |

**URL Structure:**
```text
https://www.wisden.com/default.aspx?methodtype=3&client={CLIENT_MATCHES}&sport=1&league=0&timezone=0530&language=en&daterange={START}-{END}
```
- `daterange`: `DDMMYYYY-DDMMYYYY` (e.g., `01122025-31122025`)
- **Limit**: Max range of **30 days** per request.
- **Chaining**: To fetch more than 30 days, make multiple requests (e.g., Dec 1-30, Nov 1-30) and merge arrays.

---

### C. Scorecard (Match Details)
Provides detailed innings data, player stats, fall of wickets, and partnerships.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/App.tsx` (Line 125) |
| **Poll Interval** | 15s (Synced with Wallstream for Live games) |
| **Sample Data** | [scorecard.json](api_samples/core/scorecard.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/game/scorecard?lang=en&feed_format=json&client_id={CLIENT_SCORECARD}&game_id={GAME_ID}
```

---

### D. Wallstream (Ball-by-Ball)
The "Heartbeat" of the Live Detail view. Provides real-time commentary, ball speed, and detailed event metadata.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/App.tsx` (via `useCricketData`) |
| **Poll Interval** | 10s (Live - Active Match Only) |
| **Sample Data** | [wallstream.json](api_samples/core/wallstream.json) |

**URL Structure:**
```text
https://www.wisden.com/functions/wallstream/?sport_id=1&client_id={WALLSTREAM_CLIENT}&match_id={MATCH_ID}&page_size=10&page_no=1&session={INNINGS}
```
- `match_id`: derived from `game_id` (last 6 digits usually).
- `session`: Current innings number (1, 2, 3, 4).

---

### E. Head-to-Head (H2H)
Provides historic stats, team form, and venue records. Used for *Win Probability* and *Squad* tabs.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/components/LiveDetail.tsx` (on Mount) |
| **Poll Interval** | Once per match load |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/game/head-to-head?client_id={CLIENT_SCORECARD}&feed_format=json&game_id={GAME_ID}&lang=en
```

---

### F. Chart Data (OBO & Splits)
Static JSON files generated by the backend for data visualization (Wagon Wheel, Manhattan, Worm).

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/components/LiveDetail.tsx` (Reactive to Scorecard) |
| **Poll Interval** | On Over Change / Innings Change |

**1. Batsman Splits (Wagon Wheel):**
```text
https://www.wisden.com/cricket/live/json/{MATCH_FILE}_batsman_splits_{INNINGS}.json
```

**2. Over-by-Over (Manhattan/Worm):**
```text
https://www.wisden.com/cricket/live/json/{MATCH_FILE}_overbyover_{INNINGS}.json
```
- `MATCH_FILE`: `game_id` with special chars removed (alphanumeric only).

> **Note**: `match_id` is the **last 6 digits** of the alphanumeric `game_id`.
> Example: `game_id="afupku12272025268833"` -> `match_id="268833"`

---

### E. Head-to-Head (H2H) & Stats
Fetches historical data, recent form, and venue statistics for the "Analysis" tab.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/components/MatchDetail.tsx` (via `useH2HData` hook) |
| **Sample Data** | [h2h_full.json](api_samples/core/h2h_full.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/game/head-to-head?client_id={CLIENT_SCORECARD}&feed_format=json&game_id={GAME_ID}&lang=en
```

---

### F. Team Profile
Provides comprehensive team information including coach details, social media, trophy cabinet, and team history.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [team_profile.json](api_samples/new_apis/team_profile.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/team?team_id={TEAM_ID}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Key Data:**
- Team names (full, short, display)
- Gender, nationality, home venue
- Coach/staff role details
- Social media links
- Trophy cabinet and achievements
- Team writeup/history

---

### G. Team Schedule (Recent/Upcoming)
Fetches recent or upcoming matches for a specific team. **This is used to calculate the Form Guide** (W/L/D indicators).

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [team_schedule.json](api_samples/new_apis/team_schedule.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/schedule?is_recent={BOOL}&team_id={TEAM_ID}&page_size={SIZE}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Parameters:**
- `is_recent`: `true` for recent matches, `false` for upcoming
- `team_id`: Team identifier (e.g., `1126` for India Women)
- `page_size`: Number of matches to fetch (e.g., `5` for last 5 matches)

**Form Guide Implementation:**
```typescript
// Get last 5 matches for team
const response = await fetch(schedule_api + "?is_recent=true&team_id=1126&page_size=5");
const form = response.data.matches.map(match => {
  if (match.winning_team_id === teamId) return 'W';
  if (match.match_status.includes('Tied')) return 'T';
  if (match.match_status.includes('Draw')) return 'D';
  return 'L';
});
// Result: ['W', 'W', 'L', 'W', 'D']
```

> [!NOTE]
> The `/cricket/v1/team/form` endpoint exists but returns 404/empty for most teams. Use this schedule approach instead.

---

### H. Rankings (ICC)
Fetches ICC rankings for teams or players across all formats.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [rankings_t20i.json](api_samples/new_apis/rankings_t20i.json), [rankings_t20i_batting.json](api_samples/new_apis/rankings_t20i_batting.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/ranking?comp_type={COMP}&gender={GENDER}&type={TYPE}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Parameters:**
- `comp_type`: `1` = Test, `2` = ODI, `3` = T20I
- `gender`: `1` = Men, `2` = Women
- `type`: `1` = Team, `2` = Batting, `3` = Bowling, `4` = All-rounder

**Examples:**
```bash
# Men's T20I Team Rankings
comp_type=3&gender=1&type=1

# Women's T20I Batting Rankings
comp_type=3&gender=2&type=2
```

**Key Data:**
- Current ranking position and points
- Rank change indicator
- Career best ranking
- Player/team details

---

### I. Player Profile
Comprehensive player information including biography, career statistics, and social media.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [player_profile.json](api_samples/new_apis/player_profile.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/player?player_id={PLAYER_ID}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Key Data:**
- Full name, DOB, nationality, place of birth
- Playing role, batting style, bowling style
- Detailed biography/writeup (HTML formatted)
- Social media links (Facebook, Twitter, Instagram, etc.)
- Career statistics across all formats
- Records and achievements

---

### J. Venue Information
Detailed venue information including history, statistics, and records across all formats.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [venue.json](api_samples/new_apis/venue.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/venue?venue_id={VENUE_ID}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Key Data:**
- Venue name, city, country
- Capacity, floodlights, established date
- Venue ends, coordinates (lat/long)
- Detailed history/writeup
- Format-wise statistics (Tests, ODIs, T20Is):
  - Average scores per innings
  - Highest/lowest totals
  - Win percentages batting first/second
  - Most successful teams/players
  - Records (highest individual score, best bowling, etc.)

---

### K. Series Information
Series details including participating teams, results, and tour information.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Sample Data** | [series.json](api_samples/new_apis/series.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/v1/series?series_id={SERIES_ID}&lang=en&feed_format=json&client_id={CLIENT_SCORECARD}
```

**Key Data:**
- Series name, start/end dates
- Competition type (Test/ODI/T20I)
- Tour information
- Participating teams with match statistics (wins/losses/draws/tied)
- Series result/status
- Whether teams have squads available
- Coverage level

---

### L. Live Insights (Matchups & Wagon Wheel)

Detailed match analytics powered by two complementary endpoints.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/components/LiveDetail.tsx` (Lines 65, 75) via `useCricketData.ts` |
| **Poll Interval** | Updates on innings change / user request |
| **Sample Data** | [batsman_splits.json](api_samples/insights_api/batsman_splits.json), [overbyover.json](api_samples/insights_api/overbyover.json) |

#### 1. Batsman Splits (Matchups & Wagon Wheel)
Provides aggregated stats for valid shots, zones, and bowler matchups.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/utils/useCricketData.ts` (Line 410) |
| **Sample Data** | [batsman_splits.json](api_samples/insights_api/batsman_splits.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/live/json/{MATCH_FILE_ID}_batsman_splits_{INNINGS}.json
```
- `{MATCH_FILE_ID}`: Lowercase alphanumeric filtered `game_id` (e.g., `inwslw12282025268163`)
- `{INNINGS}`: 1, 2, 3, or 4

**Key Data Structure:**
```json
{
  "Batsmen": {
    "{PLAYER_ID}": {
      "Batsman": "Name",
      "Against": {
        "{BOWLER_ID}": {
          "Bowler": "Name",
          "Runs": "12",
          "Balls": "8",
          "Dots": "2",
          "Strikerate": "150",
          "Scoringshots": "6",
          "Fours": "2",
          "Sixes": "0"
        }
      },
      "Shots": [
        {
          "Id": "5",
          "Runs": "1",
          "Zone": "8", // 1-8 Wagon Wheel Zones
          "Angle": "340",
          "Distance": "3"
        }
      ]
    }
  }
}
```

#### 2. Over-by-Over (Innings Progression & Wickets)
Provides ultra-granular ball-by-ball details. Critical for identifying **Wickets** which are absent in the Splits API.

| Feature | Details |
| :--- | :--- |
| **Method** | `GET` |
| **Initiation Point** | `src/utils/useCricketData.ts` (Line 423) |
| **Sample Data** | [overbyover.json](api_samples/insights_api/overbyover.json) |

**URL Structure:**
```text
https://www.wisden.com/cricket/live/json/{MATCH_FILE_ID}_overbyover_{INNINGS}.json
```

**Key Data Structure:**
```json
{
  "Overbyover": [
    {
      "Over": 1,
      "Runs": "10",
      "Wickets": "0", // Total wickets in this over
      "Batsmen": {
        "{PLAYER_ID}": {
          "Batsman": "Name",
          "Runs": "9",
          "Isout": true // Boolean OR String "true"/"1" - CRITICAL FLAG
        }
      },
      "Bowlers": {
        "{BOWLER_ID}": {
          "Bowler": "Name",
          "Runs": "10"
        }
      }
    }
  ]
}
```

> [!NOTE]
> The Live Insights component merges these two feeds: Splits for stats + OverByOver for Wicket confirmation.

---

## 4. Client Identifiers & Config

**Source of Truth:** `src/utils/wisdenConfig.ts`

This file contains the hardcoded Client IDs required for API access. If APIs stop working, these likely rotated.

| Key | Value (Current) | Purpose |
| :--- | :--- | :--- |
| `CLIENT_MATCHES` | `e656463796` | Matches List & Results API |
| `CLIENT_SCORECARD` | `430fdd0d` | Scorecard, H2H, Team, Rankings, Player, Venue, Series, Schedule APIs |
| `WALLSTREAM_CLIENT` | `lx/QMpdauKZQKYaddAs76w==` | Wallstream Auth (URL Encode this!) |

> [!TIP]
> **How to find new keys:**
> 1. Visit wisden.com live scores page.
> 2. Open Network Tab.
> 3. Filter for `client_id` or `client=` in requests.
> 4. Update `src/utils/wisdenConfig.ts` with new values.

---

## 5. Testing & Verification

Information to verify API health.

**Curl Command Template:**
```bash
# Test Live Matches
curl -s "https://cricket-proxy.boxboxcric.workers.dev/?url=https%3A%2F%2Fwww.wisden.com%2Fdefault.aspx%3Fmethodtype%3D3%26client%3De656463796%26sport%3D1%26league%3D0%26timezone%3D0530%26language%3Den%26gamestate%3D1"

# Test Wallstream (Replace MATCH_ID)
# Note: Client ID must be double encoded if testing via curl against proxy manually
curl "https://cricket-proxy.boxboxcric.workers.dev/?url=https%3A%2F%2Fwww.wisden.com%2Ffunctions%2Fwallstream%2F%3Fsport_id%3D1%26client_id%3Dlx%2FQMpdauKZQKYaddAs76w%3D%3D%26match_id%3D268833%26page_size%3D10%26page_no%3D1%26session%3D1"
```

> [!TIP]
> Always check `game_id` from the **Matches List** first. It changes for every match. Do not hardcode `game_id` in production.

---

## 6. Supabase Match Database

A custom database for team-based match filtering that Wisden APIs don't support natively.

### Overview

| Feature | Details |
| :--- | :--- |
| **Provider** | Supabase (PostgreSQL) |
| **Project ID** | `ycumznofytwntinxlxkc` |
| **URL** | `https://ycumznofytwntinxlxkc.supabase.co` |
| **Total Matches** | 15,209+ (auto-synced every 12h) |
| **Sync Script** | `scripts/sync_supabase.js` |
| **GitHub Action** | `.github/workflows/sync-supabase.yml` |

---

### Table Schema: `matches`

```sql
CREATE TABLE matches (
  id TEXT PRIMARY KEY,              -- Match ID (e.g., "inwslw12262025268162")
  match_date DATE NOT NULL,         -- Match date (YYYY-MM-DD)
  teama_id TEXT NOT NULL,           -- Team A ID (e.g., "1126")
  teamb_id TEXT NOT NULL,           -- Team B ID (e.g., "1133")
  teama TEXT,                       -- Team A name (e.g., "India Women")
  teamb TEXT,                       -- Team B name (e.g., "Sri Lanka Women")
  winner_id TEXT,                   -- Winner team ID (null if draw/no result)
  result TEXT,                      -- Result text (e.g., "India Women beat Sri Lanka Women by 8 wickets")
  league TEXT,                      -- League code (e.g., "icc", "ipl", "indian_domestic")
  series_id TEXT,                   -- Series ID
  series_name TEXT,                 -- Series name
  venue TEXT,                       -- Venue name
  match_type TEXT,                  -- Format (e.g., "test", "odi", "t20")
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);

-- Indexes for fast querying
CREATE INDEX idx_matches_teama ON matches(teama_id);
CREATE INDEX idx_matches_teamb ON matches(teamb_id);
CREATE INDEX idx_matches_date ON matches(match_date DESC);
CREATE INDEX idx_matches_league ON matches(league);
```

---

### Available League Codes

| League Code | Description | Count |
| :--- | :--- | :--- |
| `icc` | International Cricket | ~4,500 |
| `indian_domestic` | Indian Domestic | ~2,800 |
| `english_domestic` | English Domestic | ~2,300 |
| `womens_international` | Women's International | ~2,350 |
| `australian_domestic` | Australian Domestic | ~1,250 |
| `ipl` | Indian Premier League | ~620 |
| `youth_international` | Youth International | ~580 |

---

### API Usage (Client Utility)

**Source:** `src/utils/matchDatabase.ts`

```typescript
import { getTeamForm, getTeamMatches, getH2HMatches, getMatchesByLeague } from './utils/matchDatabase';

// Get team's recent form (last 5 matches)
const form = await getTeamForm('1126', 5);
// Returns: ['W', 'W', 'W', 'L', 'W']

// Get team's recent matches
const matches = await getTeamMatches('1126', 10);

// Get head-to-head matches between two teams
const h2h = await getH2HMatches('1126', '1133', 10);

// Get recent IPL matches
const iplMatches = await getMatchesByLeague('ipl', 50);
```

---

### Direct Supabase Queries

For advanced filtering, query Supabase directly:

```typescript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  'https://ycumznofytwntinxlxkc.supabase.co',
  'sb_publishable_Cwxlp3Az6TKQBXsIXnUemg_A4Avw-71'
);

// Get all matches for a team (either home or away)
const { data } = await supabase
  .from('matches')
  .select('*')
  .or(`teama_id.eq.1126,teamb_id.eq.1126`)
  .order('match_date', { ascending: false })
  .limit(10);

// Get IPL matches in 2025
const { data } = await supabase
  .from('matches')
  .select('*')
  .eq('league', 'ipl')
  .gte('match_date', '2025-01-01')
  .order('match_date', { ascending: false });

// Get matches at a specific venue
const { data } = await supabase
  .from('matches')
  .select('*')
  .ilike('venue', '%Wankhede%');

// Count wins for a team
const { count } = await supabase
  .from('matches')
  .select('*', { count: 'exact', head: true })
  .eq('winner_id', '1126');
```

---

### Filter Operators

| Operator | Example | Description |
| :--- | :--- | :--- |
| `.eq()` | `.eq('league', 'ipl')` | Equals |
| `.neq()` | `.neq('winner_id', null)` | Not equals |
| `.gt()` / `.gte()` | `.gte('match_date', '2024-01-01')` | Greater than (or equal) |
| `.lt()` / `.lte()` | `.lte('match_date', '2024-12-31')` | Less than (or equal) |
| `.like()` / `.ilike()` | `.ilike('teama', '%India%')` | Pattern match (case-insensitive) |
| `.in()` | `.in('league', ['ipl', 'icc'])` | In array |
| `.or()` | `.or('teama_id.eq.1126,teamb_id.eq.1126')` | OR condition |
| `.is()` | `.is('winner_id', null)` | IS NULL check |

---

### Common Team IDs

| Team | ID | Type |
| :--- | :--- | :--- |
| India | `4` | International |
| India Women | `1126` | International |
| Mumbai Indians | `1111` | IPL |
| Chennai Super Kings | `1108` | IPL |
| Royal Challengers Bengaluru | `1105` | IPL |
| Kolkata Knight Riders | `1106` | IPL |

> [!TIP]
> For a full list of IPL team IDs, see `api_samples/ipl/README.md`

---

### GitHub Secrets Required

| Secret | Value |
| :--- | :--- |
| `SUPABASE_URL` | `https://ycumznofytwntinxlxkc.supabase.co` |
| `SUPABASE_SERVICE_KEY` | Service role key (for write access) |

---

### Dashboard

**View/Edit Data:** https://supabase.com/dashboard/project/ycumznofytwntinxlxkc/editor
